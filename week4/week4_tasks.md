# Week 4 任务指南：Typing & Type-Flaw Resistance

本周有两个核心任务：引入消息格式（Format）使协议类型无缺陷，以及去除 A 预先知道所有人公钥的简化假设。

---

## 1. 协议开发任务一：引入格式，消除类型混淆

### 背景
在当前的 AnB 协议中，消息是通过纯粹的逗号拼接传输的，例如：
```
{A, B, P, ReqA, N_A}inv(pk(IdP))
```
这种写法存在**类型混淆（Type Flaw）**的风险：不同角色发出的两条格式不同的消息，可能在语法上能够被统一（unify），导致入侵者可以用一条消息冒充另一条。

### 任务要求
* 参照课件中的 **Format（格式标签）** 方法，为每条消息加上唯一的类型标签，将所有"裸拼接"替换为带格式的结构。
* 确保协议中任意两条消息（非变量）如果可以被 unify，则它们必须具有**相同的类型**。
* 更新 `.AnB` 文件（建议命名为 `week4_v1.AnB`）。

### 操作示例
原始消息（无格式）：
```
IdP->A: {A, B, P, ReqA, N_A}inv(pk(IdP))
```
加入格式标签后（示意）：
```
IdP->A: {cert, A, B, P, ReqA, N_A}inv(pk(IdP))
```
其中 `cert` 是一个 `Constant`（或协议内唯一标识符），用于标记这条消息是"IdP 颁发的证书"类型，与其他消息区分。

---

## 2. 协议开发任务二：去除 A 预知所有公钥的假设

### 背景
Week 3 中为了简化，允许 A 初始就知道所有人的公钥（`pk(B)`, `pk(P)`, `pk(IdP)`）。
Week 4 要求去掉这个假设，使协议更真实：

> **A 初始只知道 IdP 的公钥 `pk(IdP)`，不知道 B 和 P 的公钥。**

### 任务要求
* 设计一个**独立的子协议**，让 A 在需要时向 IdP 查询某个参与者的公钥。
* 这个子协议应该是独立的 AnB 文件（建议命名为 `week4_keylookup.AnB`）。
* 主协议（`week4_v1.AnB`）中，A 的初始知识只保留 `pk(IdP)`，B 和 P 的公钥通过子协议获取。

### 子协议设计参考
```
A 向 IdP 查询 B 的公钥：

A -> IdP: A, B              （我想知道 B 的公钥）
IdP -> A: {B, pk(B)}inv(pk(IdP))   （IdP 签名背书 B 的公钥）
```
IdP 的回应需要用 `inv(pk(IdP))` 签名，这样 A 用已知的 `pk(IdP)` 验证后，才能信任收到的公钥是真实的。

---

## 3. 本周特殊任务（Special Task）：证明协议是 Type-Flaw Resistant

### 任务描述
证明你的协议（主协议 + 子协议）是**类型无缺陷的（Type-Flaw Resistant）**。

### 定义
协议是 Type-Flaw Resistant，当且仅当：

> 对于协议的最简消息集合（SMP, Set of Most general message Patterns）中，任意两条消息 $m_1$ 和 $m_2$，若它们**不是变量本身**，且存在一个 unifier $\sigma$ 使得 $\sigma(m_1) = \sigma(m_2)$，则 $m_1$ 和 $m_2$ 的**类型相同**。

### 证明步骤
1. **列出 SMP**：写出协议中所有消息的最一般模式（去掉具体值，保留变量和结构）。
2. **两两比较**：对 SMP 中任意两条消息，检查它们是否存在 unifier。
3. **验证类型一致性**：若存在 unifier，说明这两条消息的顶层格式标签（类型）必须相同；若格式标签不同，则不可能被 unify（证明无类型混淆）。
4. **结论**：若所有消息对要么不可 unify，要么类型相同，则协议是 Type-Flaw Resistant。

---

## 4. Lab Logbook 更新

在 `week4/lab_logbook.md` 中记录本周快照，必须包含：

* **版本说明**：与 Week 3 相比的变化（格式标签的引入、公钥查询子协议的设计）。
* **建模考量**：
  * 如何选择格式标签（Constant 还是其他方式）？
  * 子协议与主协议如何衔接？A 在什么时机执行公钥查询？
* **问题记录**：
  * 引入格式后 OFMC 是否还发现攻击？
  * 类型标签是否解决了 Week 3 中 IdP 身份混淆的问题？
* **Special Task 证明过程**（可直接写在 logbook 里）。

---

## 5. 关键概念提示

| 概念 | 说明 |
|------|------|
| **Type Flaw** | 两条不同语义的消息在语法上可以 unify，入侵者利用此混淆欺骗诚实代理 |
| **SMP** | Set of Most general message Patterns，协议中所有消息的最一般化模式集合 |
| **Unifier** | 一个替换 $\sigma$，使得 $\sigma(m_1) = \sigma(m_2)$ |
| **Format/Tag** | 消息中加入的唯一常量标签，用于区分不同类型的消息 |
| **Key Lookup Protocol** | A 向 IdP 查询公钥的独立子协议，确保 A 获得的公钥是经过 IdP 背书的 |
